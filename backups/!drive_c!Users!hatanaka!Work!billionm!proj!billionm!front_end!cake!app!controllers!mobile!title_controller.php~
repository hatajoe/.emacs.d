<?php
// ユーザ側根底コントローラインポート
require CONTROLLERS . "user_app_controller.php";

/**
 * 称号
 *
 * @author hikashi
 */
class TitleController extends UserAppController {

    var $name = "Title";
    var $uses = array();
    var $components = array("Mobile",
                            "PeopleApi");


    /**
     * 称号一覧
     */
    public function title_list($type = 2,$page = 0) {
        
        // タイプ整理
        if($type != 1 && $type != 2 && $type != 3 && $type != 4 && $type != 5){
            $type = 2;
        }

        $this->TMemberTitle     = ClassRegistry::init("TMemberTitle");
        $this->MTitle           = ClassRegistry::init("MTitle");
        $this->MTitleCondition  = ClassRegistry::init("MTitleCondition");

        
        // 称号
        $mTitles = $this->MTitle->getTitleList();
        
        // 設定中称号
        $myTitle = $this->TMember->getMemberTitle($this->member["id"]);
        
        // 会員称号
        $tMemberTitleList = $this->TMemberTitle->getTitleList($this->member["id"]);
        
        // 称号条件
        $typeList = $this->MTitleCondition->getTitleConditonListByTipe($type);
        $tMemberTitleListType = array();
        if(!empty($typeList)){
            foreach($typeList as $id){
                if(in_array($id, $tMemberTitleList)) {
                    $tMemberTitleListType[] = array("id" => $id, "next" => false);
                } 
            }
        }
        // 称号獲得チェック
        $hintTitle = array();
        $this->TMemberKboss = ClassRegistry::init("TMemberKboss");
        if($type == 1){
            $this->MKbossEvent = ClassRegistry::init("MKbossEvent");
            $kbossEventId = $this->MKbossEvent->getEventID();
            if(!empty($kbossEventId)){
                $tMemberKboss = $this->TMemberKboss->getMemberKboss($this->member["id"],$kbossEventId);
                if(empty($tMemberKboss)){
                    $tMemberKboss = array();
                    $tMemberKboss["kill_num_mine"] = 0;
                }
                $nextTitle = $this->MTitleCondition->next($type,$tMemberKboss["kill_num_mine"],$kbossEventId);
                if(!empty($nextTitle)){
                    $nextParam = $nextTitle["param"] - $tMemberKboss["kill_num_mine"];
                    $hintTitle = array("type" => $type, "nextParam" => $nextParam);
                    $tMemberTitleListType[] = array("id" => $nextTitle["m_title_id"], "next" => true);
                }
            }
        } else {
            $tMemberKbossData = $this->TMemberKboss->getKillNumLogTotal($this->member["id"]);
            switch($type){
                case 2:
                    $param = empty($tMemberKbossData["kill_num_mine"]) ? 0 : $tMemberKbossData["kill_num_mine"];
                    break;
                case 3:
                    $p1 = empty($tMemberKbossData["kill_num_friend"]) ? 0 : $tMemberKbossData["kill_num_friend"];
                    $p2 = empty($tMemberKbossData["kill_num_etc"]) ? 0 : $tMemberKbossData["kill_num_etc"];
                    $param = ($p1 + $p2);
                    break;
                case 4:
                    $param = empty($tMemberKbossData["kill_num_friend"]) ? 0 : $tMemberKbossData["kill_num_friend"];
                    break;
                case 5:
                    $param = empty($tMemberKbossData["kill_num_etc"]) ? 0 : $tMemberKbossData["kill_num_etc"];
                    break;
            }
            $nextTitle = $this->MTitleCondition->next($type,$param);
            if(!empty($nextTitle)){
                $nextParam = $nextTitle["param"] - $param;
                $hintTitle = array("type" => $type, "nextParam" => $nextParam);
                $tMemberTitleListType[] = array("id" => $nextTitle["m_title_id"], "next" => true);
            }
        }

        // 所持称号数
        $titleCount = count($tMemberTitleListType);
        
        // 名前
        $nickname = $this->_getNickname($this->member["id"]);
        
        //----------------------------------------
        // データを整形する
        //----------------------------------------
        $dispNum = 10;
        $maxPage = ($titleCount<=$dispNum) ? 0 : ceil($titleCount/$dispNum) - 1;
        if(intval($page) < 0){
            $page = 0;
        } else if(intval($page) > $maxPage){
            $page = $maxPage;
        }
        $titleList = array();
        if(!empty($titleCount)){
            
            $start_pos = $dispNum * $page;
            if(isset($tMemberTitleListType[($start_pos + $dispNum - 1)])){
                $end_pos = $start_pos + $dispNum;
            } else {
                $end_pos = $start_pos + ($titleCount % $dispNum);
            }
   
            for($i=$start_pos; $i<$end_pos;$i++){
                $id = $tMemberTitleListType[$i]["id"];
                $next = $tMemberTitleListType[$i]["next"];
                //$titleCondition = $this->MTitleCondition->getTitleConditonByTitleId($id);
                // もしボスやイベントに関連付けがいる場合ここでチェックして情報追加
                //if($titleCondition["type"] == ){
                //    $titleCondition[""] = ;
                //}
                $mTitle = $this->MTitle->getDataById($id);
                $titleList[] = array("id" => $id, "name" => $mTitles[$id], "description" => $mTitle["description"], "next" => $next);
            }
        }
        
        $nowTitle = array();
        if(!empty($myTitle["m_title_id"])){
            $nowTitle = array("id" => $myTitle["m_title_id"], "name" => $mTitles[$myTitle["m_title_id"]]);
        } 
        
        $rb = isset($this->params["url"]["rb"]) ? $this->params["url"]["rb"] : 0;
        $rvp = 0;
        if(!empty($rb)){
            $rvp = isset($this->params["url"]["rvp"]) ? $this->params["url"]["rvp"] : 0;
            if($rvp != 0 && $rvp != 10){
                $rvp = 0;
            }
        }
        $this->set("rvp"         , $rvp);
        $this->set("rb"          , $rb);


        //----------------------------------------
        // データを設定する
        //----------------------------------------
        //ページャー
        $this->setPagerNext($titleList, $titleCount, $page, $dispNum);
        
        $this->set("nowTitle"    , $nowTitle);
        $this->set("nickname"    , $nickname);
        $this->set("type"        , $type);
        $this->set("hintTitle"   , $hintTitle);

    }

    /**
     * 称号設定
     */
    public function set_title() {

        //----------------------------------------
        // 使用するモデルをインスタンス化する
        //----------------------------------------
        $this->TMemberTitle     = ClassRegistry::init("TMemberTitle");

        //----------------------------------------
        // リクエストパラメータを取得する
        //----------------------------------------
        // 属性
        if (isset($this->data["form"]["id"])) {

            $id = $this->data["form"]["id"];

        } else {

            $this->redirect("/title/title_list");
        }
        
        $rb = isset($this->data["form"]["rb"]) ? $this->data["form"]["rb"] : 0;
        if(!empty($rb)){
            $rvp = isset($this->data["form"]["rvp"]) ? $this->data["form"]["rvp"] : 0;
            if($rvp != 0 && $rvp != 10){
                $rvp = 0;
            }
        }

        //----------------------------------------
        // データを取得する
        //----------------------------------------
        // 称号情報
        $tMemberTitle = $this->TMemberTitle->hasTitle($this->member["id"],$id);
        if(empty($tMemberTitle)){
            $this->redirect("/title/title_list");
        }

        //----------------------------------------
        // データを設定する
        //----------------------------------------
        $this->TMember->setTitle($this->member["id"],$id);
        
        if(!empty($rb)){
            $this->redirect("/title/set_comp?rb=".$rb."&rvp=".$rvp);
        } else {
            $this->redirect("/title/set_comp");
        }

    }


    /**
     * 称号設定結果
     */
    public function set_comp(){
        $tail = "";
        $rb = isset($this->params["url"]["rb"]) ? $this->params["url"]["rb"] : 0;
        if(!empty($rb)){
            $rvp = isset($this->params["url"]["rvp"]) ? $this->params["url"]["rvp"] : 0;
            if($rvp != 0 && $rvp != 10){
                $rvp = 0;
            }
            $tail = "?rvp=".($rvp + 1);
        }
        $this->set("rb"          , $rb);
        $this->set("tail"        , $tail);
        
    }




}